import{_ as g}from"./chunks/ArticleMetadata.DArXzXOG.js";import{_ as A,m as y,a as o,u as p,B as e,e as s,x as t,aU as D,ai as c,o as h,p as r,q as d,aV as F}from"./chunks/framework.DGhdORX1.js";import"./chunks/theme.C7H76Bwr.js";const N=JSON.parse('{"title":"OAuth2客户端对接认证服务","description":"","frontmatter":{"title":"OAuth2客户端对接认证服务","author":"vains","date":"2024-05-05 13:00","isTop":"fasle","categories":["认证服务集成"],"tags":["Spring Boot","Spring Security","Spring Security OAuth2 Client","Spring OAuth2 Authorization Server"],"showComment":false},"headers":[],"relativePath":"authorization-server/04-进阶教程/02-oauth2-client-integration-server-provider.md","filePath":"authorization-server/04-进阶教程/02-oauth2-client-integration-server-provider.md","lastUpdated":null}'),C={name:"authorization-server/04-进阶教程/02-oauth2-client-integration-server-provider.md"},B=s("h1",{id:"前言",tabindex:"-1"},[t("前言 "),s("a",{class:"header-anchor",href:"#前言","aria-label":'Permalink to "前言"'},"​")],-1),u=s("p",null,"在之前的文章中实现了一个认证服务，并且添加了一些自定义的内容，现在暂时没想到认证服务的新内容，本篇文章就先写一下客户端对接的吧，水一篇。",-1),E=s("h1",{id:"流程说明",tabindex:"-1"},[t("流程说明 "),s("a",{class:"header-anchor",href:"#流程说明","aria-label":'Permalink to "流程说明"'},"​")],-1),m=s("p",null,[s("img",{src:D,alt:"客户端获取认证过程"})],-1),f=s("p",null,"当用户通过客户端去访问一个受限的资源时，客户端会检测是否有登录信息，没有登录信息会重定向至认证服务器去请求授权，认证服务器会检测是否有登录信息(检查session)，检测到没有登录则重定向至登录页面返回给用户，用户输入账号密码后提交，认证服务器认证以后会重定向至授权接口，授权接口生成一个code之后携带code重定向至客户端配置的redirect_uri，Security OAuth2 Client默认实现了一个处理回调的接口，会自动使用code获取token，地址为：/login/oauth2/code/*，最后的*要填配置客户端的registrationId，后边会提到；然后该接口请求认证服务去获取一个access_token，用access_token换取用户信息，框架会将token的信息存入session中，以后再发起请求时会从session中获取token。",-1),_=s("h1",{id:"使用springboot创建一个oauth2客户端",tabindex:"-1"},[t("使用SpringBoot创建一个oauth2客户端 "),s("a",{class:"header-anchor",href:"#使用springboot创建一个oauth2客户端","aria-label":'Permalink to "使用SpringBoot创建一个oauth2客户端"'},"​")],-1),b=c('<h2 id="环境介绍" tabindex="-1">环境介绍 <a class="header-anchor" href="#环境介绍" aria-label="Permalink to &quot;环境介绍&quot;">​</a></h2><p>客户端这里就是一个独立的项目了，跟之前的认证服务没有什么关联，读者可自选自己使用的Spring Boot版本，各版本的oauth2 client版本的对接大差不差，基本上差不多，可能实现会有所不同，但基本都一样的。在对接过程中我会放一些文档，读者可以去文档中找对应版本的文档去编写代码。</p><h2 id="创建项目" tabindex="-1">创建项目 <a class="header-anchor" href="#创建项目" aria-label="Permalink to &quot;创建项目&quot;">​</a></h2><p>使用idea或者在<a href="https://start.spring.io/" target="_blank" rel="noreferrer">Spring Initializr</a>创建一个SpringBoot项目；创建时引用oauth2-client和web依赖。</p><p><img src="'+F+`" alt="image.png"></p><h3 id="pom-xml示例" tabindex="-1">pom.xml示例 <a class="header-anchor" href="#pom-xml示例" aria-label="Permalink to &quot;pom.xml示例&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;?</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">xml version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;1.0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> encoding</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;UTF-8&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">?&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">project xmlns</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;http://maven.apache.org/POM/4.0.0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> xmlns</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">xsi</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">         xsi</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">schemaLocation</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">modelVersion</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">4.0</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">.</span><span style="--shiki-light:#B31D28;--shiki-dark:#FF938A;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">modelVersion</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">parent</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">groupId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">org.springframework.boot</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">groupId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">artifactId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">spring</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">boot</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">starter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">parent</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">artifactId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">3.1</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">.</span><span style="--shiki-light:#B31D28;--shiki-dark:#FF938A;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">relativePath</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">/&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &lt;!--</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> lookup parent from repository </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">--&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    &lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">parent</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">groupId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">com.example</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">groupId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">artifactId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">authorization</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">client</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">example</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">artifactId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">0.0</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">.</span><span style="--shiki-light:#B31D28;--shiki-dark:#FF938A;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">SNAPSHOT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">authorization</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">client</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">example</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">description</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">authorization</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">client</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">example</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">description</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">properties</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">java.version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">17</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">java.version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    &lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">properties</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">dependencies</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">dependency</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">            &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">groupId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">org.springframework.boot</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">groupId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">            &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">artifactId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">spring</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">boot</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">starter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">oauth2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">client</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">artifactId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        &lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">dependency</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">dependency</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">            &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">groupId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">org.springframework.boot</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">groupId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">            &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">artifactId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">spring</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">boot</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">starter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">web</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">artifactId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        &lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">dependency</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">dependency</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">            &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">groupId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">org.springframework.boot</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">groupId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">            &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">artifactId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">spring</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">boot</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">starter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">test</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">artifactId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">            &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">scope</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">test</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">scope</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        &lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">dependency</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    &lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">dependencies</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">build</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">plugins</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">            &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">plugin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">                &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">groupId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">org.springframework.boot</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">groupId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">                &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">artifactId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">spring</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">boot</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">maven</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">plugin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">artifactId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">            &lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">plugin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        &lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">plugins</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    &lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">build</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">project</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span></code></pre></div><h2 id="配置application-yml-添加认证服务器信息和客户端信息" tabindex="-1">配置application.yml，添加认证服务器信息和客户端信息 <a class="header-anchor" href="#配置application-yml-添加认证服务器信息和客户端信息" aria-label="Permalink to &quot;配置application.yml，添加认证服务器信息和客户端信息&quot;">​</a></h2><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">server</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">  # 修改端口</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  port</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">8000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">spring</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  security</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    oauth2</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      client</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        provider</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">          # 认证提供者,自定义名称</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">          custom-issuer</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">            # Token签发地址(认证服务地址)</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">            issuer-uri</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">http://192.168.120.33:8080</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">            # 获取用户信息的地址，默认的/userinfo端点需要IdToken获取，为避免麻烦自定一个用户信息接口</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">            user-info-uri</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">\${spring.security.oauth2.client.provider.custom-issuer.issuer-uri}/user</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        registration</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">          messaging-client-oidc</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">            # oauth认证提供者配置，和上边配置的认证提供者关联起来</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">            provider</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">custom-issuer</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">            # 客户端名称，自定义</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">            client-name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">message-client</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">            # 客户端id，从认证服务申请的客户端id</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">            client-id</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">messaging-client</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">            # 客户端秘钥</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">            client-secret</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">123456</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">            # 客户端认证方式</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">            client-authentication-method</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">client_secret_basic</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">            # 获取Token使用的授权流程</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">            authorization-grant-type</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">authorization_code</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">            # 回调地址，这里设置为Spring Security Client默认实现使用code换取token的接口</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">            redirect-uri</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">http://127.0.0.1:8000/login/oauth2/code/messaging-client-oidc</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">            scope</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">              - </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">message.read</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">              - </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">message.write</span></span></code></pre></div><p>更多详细的客户端配置信息移步<a href="https://docs.spring.io/spring-security/reference/servlet/oauth2/client/core.html" target="_blank" rel="noreferrer">官网文档</a> <br> <strong>文档中配置权限范围的字段是<code>scopes</code>，但是在代码中是<code>scope</code>，这里可能是文档中没更新吧，大家在参阅文档时需要注意一下代码中具体的属性名是什么。</strong></p><p><strong>注意：认证服务器和客户端在同一个机器上时不能使用同一个ip，例如127.0.0.1，在存储cookie时不会区分端口的，比如127.0.0.1:8000和127.0.0.1:8080这两个，他们的cookie是同一个的，后者会覆盖前者；如果配置认证服务的地址是127.0.0.1:8080然后通过127.0.0.1:8000去访问客户端则会在登录后出现<code>[authorization_request_not_found]</code>异常，详见<a href="https://github.com/spring-projects/spring-security/issues/5946" target="_blank" rel="noreferrer">spring-security issues 5946</a></strong></p><h2 id="给认证服务添加一个用户接口" tabindex="-1">给认证服务添加一个用户接口 <a class="header-anchor" href="#给认证服务添加一个用户接口" aria-label="Permalink to &quot;给认证服务添加一个用户接口&quot;">​</a></h2><p>在AuthorizationController中添加/user接口</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">ResponseBody</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">GetMapping</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;/user&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">public</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> Map</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">String,Object</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> user</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(Principal principal) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(principal </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">instanceof</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> JwtAuthenticationToken token)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> Collections.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">emptyMap</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> token.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">getToken</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">getClaims</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><h1 id="客户端解释" tabindex="-1">客户端解释 <a class="header-anchor" href="#客户端解释" aria-label="Permalink to &quot;客户端解释&quot;">​</a></h1>`,15),v=s("p",null,"客户端在oauth2角色解释中是第三方的一个应用，一般会配合资源服务一起使用",-1),I=s("ol",null,[s("li",null,[t("在单体项目中："),s("br"),t(" 会同时添加资源服务依赖，客户端负责调用认证服务登录，资源服务器负责解析获取到的token，然后获取token中的权限，目前token中的权限只有scope的权限，并且不太好自定义，所以就需要通过资源服务器配置去更好的解析token。")]),s("li",null,"在分布式项目中：")],-1),q=s("ul",null,[s("li",null,"在网关中添加客户端依赖，检查用户认证信息，由网关代理的微服务添加资源服务依赖，解析网关通过令牌中继的方式携带的access_token；各个微服务添加自己的授权校验。"),s("li",null,"在网关中集成客户端依赖，同时集成资源服务依赖，由网关检查用户的认证和授权信息；各个微服务不用添加任何的认证与授权相关的处理，可以直接访问；这种方式需要屏蔽各微服务其它ip的访问，只能由网关代理访问。")],-1),S=s("h1",{id:"总结",tabindex:"-1"},[t("总结 "),s("a",{class:"header-anchor",href:"#总结","aria-label":'Permalink to "总结"'},"​")],-1),w=s("p",null,[t("本篇文章以较少的代码集成了Security OAuth2 Client，体验到了springboot最开始说的"),s("code",null,"约定大于配置"),t("的好处，框架添加了大量的默认配置，只需更改必须修改的自定义部分即可，本次的代码部分只有更改yml和编写一个测试接口，其它的重定向至认证服务和获取token的配置都已经默认实现了。")],-1);function P(i,$,x,T,O,z){const l=g,k=y("ClientOnly");return h(),o("div",null,[B,p(k,null,{default:e(()=>{var a,n;return[(((a=i.$frontmatter)==null?void 0:a.aside)??!0)&&(((n=i.$frontmatter)==null?void 0:n.showArticleMetadata)??!0)?(h(),r(l,{key:0,article:i.$frontmatter},null,8,["article"])):d("",!0)]}),_:1}),u,E,p(k,null,{default:e(()=>{var a,n;return[(((a=i.$frontmatter)==null?void 0:a.aside)??!0)&&(((n=i.$frontmatter)==null?void 0:n.showArticleMetadata)??!0)?(h(),r(l,{key:0,article:i.$frontmatter},null,8,["article"])):d("",!0)]}),_:1}),m,f,_,p(k,null,{default:e(()=>{var a,n;return[(((a=i.$frontmatter)==null?void 0:a.aside)??!0)&&(((n=i.$frontmatter)==null?void 0:n.showArticleMetadata)??!0)?(h(),r(l,{key:0,article:i.$frontmatter},null,8,["article"])):d("",!0)]}),_:1}),b,p(k,null,{default:e(()=>{var a,n;return[(((a=i.$frontmatter)==null?void 0:a.aside)??!0)&&(((n=i.$frontmatter)==null?void 0:n.showArticleMetadata)??!0)?(h(),r(l,{key:0,article:i.$frontmatter},null,8,["article"])):d("",!0)]}),_:1}),v,I,q,S,p(k,null,{default:e(()=>{var a,n;return[(((a=i.$frontmatter)==null?void 0:a.aside)??!0)&&(((n=i.$frontmatter)==null?void 0:n.showArticleMetadata)??!0)?(h(),r(l,{key:0,article:i.$frontmatter},null,8,["article"])):d("",!0)]}),_:1}),w])}const U=A(C,[["render",P]]);export{N as __pageData,U as default};
